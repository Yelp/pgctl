#!/bin/bash
set -eu

fail() { echo '[31;1mFAIL[m'; }
trap fail ERR

TOP=$(dirname $(readlink -f $0))
PROJECT=pgctl
src=$(dirname $(python -c "import $PROJECT as p; print p.__file__"))

coverage erase
py.test \
    --cov $TOP/tests --cov $src \
    --cov-config=$TOP/.coveragerc --cov-report='' \
    "$@" $TOP/tests $src
coverage combine
coverage report --rcfile=$TOP/.coveragerc --fail-under 94  # FIXME: should be 100

pre-commit run --all-files
